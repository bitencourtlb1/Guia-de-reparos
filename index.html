<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guias de Reparos Domésticos DIY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
    <style>
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
       @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-in-out;
      }
    </style>
  </head>
  <body class="bg-slate-50 font-sans text-slate-800">
    <div id="app-container"></div>

    <script type="module">
      import { GoogleGenAI, Type, Modality } from "@google/genai";

      const API_KEY = process.env.API_KEY;
      if (!API_KEY) {
        const errorHtml = `
          <div class="p-8 text-center text-red-700 bg-red-50">
            <strong>Erro de Configuração:</strong> A variável de ambiente API_KEY não está definida.
          </div>`;
        document.getElementById('app-container').innerHTML = errorHtml;
        throw new Error("API_KEY environment variable not set");
      }
      const ai = new GoogleGenAI({ apiKey: API_KEY });
      const appContainer = document.getElementById('app-container');

      // --- STATE MANAGEMENT ---
      let state = {
        tutorials: [],
        selectedTutorial: null,
        tutorialContent: null,
        loadingList: true,
        loadingContent: false,
        error: null,
      };

      function setState(newState) {
        state = { ...state, ...newState };
        renderApp();
      }
      
      // --- API SERVICE FUNCTIONS ---
      async function getTutorialList() {
        try {
          const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: "Gere uma lista de 12 tópicos comuns de reparos domésticos em Português do Brasil, adequados para um iniciante em bricolagem. Exemplos: 'Consertar um vaso sanitário com vazamento', 'Remendar um pequeno buraco em drywall'.",
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: { topics: { type: Type.ARRAY, items: { type: Type.STRING } } }
              }
            }
          });
          const jsonResponse = JSON.parse(response.text);
          return (jsonResponse && Array.isArray(jsonResponse.topics)) ? jsonResponse.topics : [];
        } catch (error) {
          console.error("Erro ao buscar lista de tutoriais:", error);
          throw new Error("Falha ao buscar a lista de tutoriais da API Gemini.");
        }
      }

      async function getTutorialSteps(topic) {
        const prompt = `
          Gere um tutorial passo a passo sobre como "${topic}". As instruções devem estar em Português do Brasil.
          Mantenha as instruções simples, claras e concisas para um iniciante completo.
          Para cada passo, forneça:
          1. Um 'stepNumber' (número do passo).
          2. Um texto curto de 'instruction' (instrução).
          3. Um 'imagePrompt' (prompt de imagem) simples e descritivo para um gerador de imagens de IA criar uma imagem clara, minimalista e em estilo de diagrama instrucional ilustrando o passo. Foque na ação e nas ferramentas. Exemplo: 'Uma mão usando uma chave de fenda para apertar o puxador solto de um armário'.
        `;
        try {
          const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  steps: {
                    type: Type.ARRAY,
                    items: {
                      type: Type.OBJECT,
                      properties: {
                        stepNumber: { type: Type.INTEGER },
                        instruction: { type: Type.STRING },
                        imagePrompt: { type: Type.STRING }
                      },
                      required: ["stepNumber", "instruction", "imagePrompt"]
                    }
                  }
                }
              }
            }
          });
          const jsonResponse = JSON.parse(response.text);
          return (jsonResponse && Array.isArray(jsonResponse.steps)) ? jsonResponse.steps : [];
        } catch (error) {
          console.error(`Erro ao buscar os passos do tutorial para "${topic}":`, error);
          throw new Error(`Falha ao buscar os passos do tutorial para "${topic}".`);
        }
      }

      async function generateImage(prompt) {
         try {
            const fullPrompt = `Uma ilustração instrucional minimalista e limpa mostrando: ${prompt}. Fundo branco, linhas simples, paleta de cores limitada. Estilo de diagrama.`;
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash-image',
                contents: {
                    parts: [{ text: fullPrompt }],
                },
                config: {
                    responseModalities: [Modality.IMAGE],
                },
            });

            const parts = response?.candidates?.[0]?.content?.parts;
            if (parts) {
                for (const part of parts) {
                    if (part.inlineData) {
                        const base64ImageBytes = part.inlineData.data;
                        return `data:image/png;base64,${base64ImageBytes}`;
                    }
                }
            }
            throw new Error("Nenhuma imagem foi gerada.");
        } catch (error) {
            console.error(`Erro ao gerar imagem para o prompt "${prompt}":`, error);
            throw new Error("Falha ao gerar a imagem.");
        }
      }

      // --- RENDERING FUNCTIONS ---
      function renderHeader() {
        return `
          <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 md:px-8 py-4">
              <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-8 w-8 text-blue-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l.354-.354a3.75 3.75 0 0 0-5.303-5.303l-.354.353.354-.354a3.75 3.75 0 0 0-5.303-5.303l-.354.353M3 3l3.579 3.579m0 0a3.75 3.75 0 0 1 5.303 5.303L11.42 15.17" />
                </svg>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Guias de Reparo DIY</h1>
              </div>
            </div>
          </header>
        `;
      }
      
      function renderFooter() {
        return `
          <footer class="text-center py-6 text-sm text-slate-500">
            <p>Desenvolvido com IA. Sempre consulte um profissional para reparos complexos.</p>
          </footer>
        `;
      }

      function renderLoadingSpinner() {
        return `<div class="w-8 h-8 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div>`;
      }

      function renderLoadingView(message) {
        return `
          <div class="flex flex-col items-center justify-center h-64">
            ${renderLoadingSpinner()}
            <p class="mt-4 text-slate-600">${message}</p>
          </div>
        `;
      }
      
      function renderErrorView(message, action) {
        return `
          <div class="text-center p-8 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-red-700 font-semibold">Ocorreu um Erro</p>
              <p class="text-red-600 mt-2">${message}</p>
              <button data-action="${action}" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                 ${state.selectedTutorial ? 'Voltar' : 'Tentar Novamente'}
              </button>
          </div>
        `;
      }

      function renderTutorialList(tutorials) {
        return `
          <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-slate-700 border-b pb-3">Escolha um Guia de Reparo</h2>
            <ul class="space-y-2">
              ${tutorials.map(topic => `
                <li>
                  <button data-action="select-tutorial" data-topic="${topic}" class="w-full text-left p-4 rounded-lg flex justify-between items-center bg-slate-50 hover:bg-blue-100 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <span class="font-medium text-slate-800">${topic}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-slate-400">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                    </svg>
                  </button>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      }
      
      function renderImagePlaceholder() {
        return `
          <div class="w-full aspect-[4/3] bg-slate-200 rounded-lg flex flex-col items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-12 w-12 text-slate-400 mb-2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
              </svg>
              <p class="text-sm text-slate-500">Gerando imagem...</p>
              <div class="mt-4">${renderLoadingSpinner()}</div>
          </div>
        `;
      }
      
      function renderImageError() {
          return `
              <div class="w-full aspect-[4/3] bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center p-4 text-center">
                  <p class="text-red-700 font-semibold">Falha na Imagem</p>
                  <p class="text-red-600 text-sm mt-1">Não foi possível gerar a ilustração para este passo.</p>
              </div>
          `;
      }

      function renderStepCard(step) {
        return `
          <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md transition-shadow hover:shadow-lg animate-fade-in-up flex flex-col md:flex-row gap-6">
            <div class="flex-shrink-0 md:w-1/3">
              <div class="flex items-center mb-2">
                  <div class="flex-shrink-0 bg-blue-600 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold text-lg">
                      ${step.stepNumber}
                  </div>
                  <div class="md:hidden ml-4 text-lg font-semibold text-slate-700">Passo ${step.stepNumber}</div>
              </div>
              <p class="mt-2 md:mt-0 text-slate-600 md:pl-0">${step.instruction}</p>
            </div>
            <div class="flex-grow md:w-2/3" id="step-image-container-${step.stepNumber}">
              ${renderImagePlaceholder()}
            </div>
          </div>
        `;
      }

      function renderTutorialViewer(topic, steps) {
        const sortedSteps = steps ? [...steps].sort((a, b) => a.stepNumber - b.stepNumber) : [];
        return `
          <div class="animate-fade-in">
            <div class="mb-6 flex items-center gap-4">
              <button data-action="go-back" class="p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition-colors" aria-label="Voltar para os tutoriais">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-slate-700">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                </svg>
              </button>
              <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">${topic}</h2>
            </div>
            <div class="space-y-6">
              ${sortedSteps.map(renderStepCard).join('')}
            </div>
          </div>
        `;
      }

      // --- MAIN APP RENDER & CONTROL ---
      
      function renderApp() {
        let mainContent = '';
        if (state.loadingList) {
          mainContent = renderLoadingView('Carregando guias de reparo...');
        } else if (state.error && !state.loadingContent) {
          mainContent = renderErrorView(state.error, state.selectedTutorial ? 'go-back' : 'retry-list');
        } else if (state.selectedTutorial) {
          if (state.loadingContent) {
            mainContent = renderLoadingView('Carregando instruções...');
          } else {
             mainContent = renderTutorialViewer(state.selectedTutorial, state.tutorialContent);
          }
        } else {
          mainContent = renderTutorialList(state.tutorials);
        }

        appContainer.innerHTML = `
          ${renderHeader()}
          <main class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
            ${mainContent}
          </main>
          ${renderFooter()}
        `;
        
        // After rendering, if we are in the tutorial view, fetch images
        if (state.selectedTutorial && state.tutorialContent && !state.loadingContent) {
            loadAllStepImages(state.tutorialContent);
        }
      }
      
      async function loadAllStepImages(steps) {
        steps.forEach(async (step) => {
            const container = document.getElementById(`step-image-container-${step.stepNumber}`);
            if (!container) return;

            try {
                const imageUrl = await generateImage(step.imagePrompt);
                container.innerHTML = `<img src="${imageUrl}" alt="Ilustração para o passo ${step.stepNumber}: ${step.instruction}" class="w-full aspect-[4/3] object-cover rounded-lg bg-slate-100">`;
            } catch (error) {
                container.innerHTML = renderImageError();
            }
        });
      }

      // --- EVENT HANDLERS ---
      
      async function handleSelectTutorial(topic) {
        setState({ selectedTutorial: topic, loadingContent: true, tutorialContent: null, error: null });
        try {
          const steps = await getTutorialSteps(topic);
          setState({ tutorialContent: steps, loadingContent: false });
        } catch (err) {
          setState({ error: 'Falha ao carregar o conteúdo do tutorial. Por favor, volte e tente novamente.', loadingContent: false });
        }
      }

      function handleGoBack() {
        setState({ selectedTutorial: null, tutorialContent: null, error: null });
      }

      async function handleFetchTutorials() {
        setState({ loadingList: true, error: null });
        try {
          const tutorialList = await getTutorialList();
          setState({ tutorials: tutorialList, loadingList: false });
        } catch (err) {
          setState({ error: 'Falha ao carregar os tutoriais. Por favor, tente novamente mais tarde.', loadingList: false });
        }
      }

      appContainer.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        if (action === 'select-tutorial') {
          handleSelectTutorial(target.dataset.topic);
        } else if (action === 'go-back') {
          handleGoBack();
        } else if (action === 'retry-list') {
          handleFetchTutorials();
        }
      });
      
      // --- INITIAL LOAD ---
      handleFetchTutorials();

    </script>
  </body>
</html>
